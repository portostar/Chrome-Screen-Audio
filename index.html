
<!--
> Muaz Khan     - www.MuazKhan.com
> MIT License   - www.WebRTC-Experiment.com/licence
> Documentation - github.com/muaz-khan/RecordRTC
> and           - RecordRTC.org
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <title>RecordRTC to PHP ® Muaz Khan</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="author" type="text/html" href="https://plus.google.com/+MuazKhan">
    <meta name="author" content="Muaz Khan">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <script src="js/jquery-1.11.0.min.js"></script>
	<script>
	var serverURL = "http://localhost:8000";
	var uploadedAudio = false;
	var uploadedVideo = false;
	</script>
    

<script src="js/test.js"></script>
    <link rel="stylesheet" href="https://cdn.webrtc-experiment.com/style.css">
    <style>
    audio {
        vertical-align: bottom;
        width: 10em;
    }
    video {
        max-width: 100%;
        vertical-align: top;
    }
    input {
        border: 1px solid #d9d9d9;
        border-radius: 1px;
        font-size: 2em;
        margin: .2em;
        width: 30%;
    }
    p,
    .inner {
        padding: 1em;
    }
    li {
        border-bottom: 1px solid rgb(189, 189, 189);
        border-left: 1px solid rgb(189, 189, 189);
        padding: .5em;
    }
    label {
        display: inline-block;
        width: 8em;
    }
    </style>
    
    <style>
        .recordrtc button {
            font-size: inherit;
        }
        
        .recordrtc button, .recordrtc select {
            vertical-align: middle;
            line-height: 1;
            padding: 2px 5px;
            height: auto;
            font-size: inherit;
            margin: 0;
        }
        
        .recordrtc, .recordrtc .header {
            display: block;
            text-align: center;
            padding-top: 0;
        }
        
        .recordrtc video {
            width: 70%;
        }
        
        .recordrtc option[disabled] {
            display: none;
        }
    </style>
    
    <script src="js/RecordRTC.js"></script>
    <script src="https://cdn.webrtc-experiment.com/gif-recorder.js"></script>
    <script src="https://cdn.webrtc-experiment.com/getScreenId.js"></script>

    <!-- for Edige/FF/Chrome/Opera/etc. getUserMedia support -->
    <script src="https://cdn.rawgit.com/webrtc/adapter/master/adapter.js"></script>
	
</head>

<body>
    <article>
        <header style="text-align: center;">
            <h1>
                <a href="https://github.com/muaz-khan/RecordRTC" target="_blank">RecordRTC</a> to <a href="https://github.com/muaz-khan/RecordRTC/RecordRTC-to-PHP" target="_blank">PHP</a> ®
                <a href="https://github.com/muaz-khan" target="_blank">Muaz Khan</a>
            </h1>
            <p>
                <a href="https://www.webrtc-experiment.com/RecordRTC/">HOME</a>
                <span> &copy; </span>
                <a href="http://www.MuazKhan.com/" target="_blank">Muaz Khan</a> .
                <a href="http://twitter.com/WebRTCWeb" target="_blank" title="Twitter profile for WebRTC Experiments">@WebRTCWeb</a> .
                <a href="https://github.com/muaz-khan?tab=repositories" target="_blank" title="Github Profile">Github</a> .
                <a href="https://github.com/muaz-khan/RecordRTC/issues?state=open" target="_blank">Latest issues</a> .
                <a href="https://github.com/muaz-khan/RecordRTC/commits/master" target="_blank">What's New?</a>
            </p>
        </header>

        <div class="github-stargazers"></div>


        
        <section class="experiment recordrtc">
            <h2 class="header">
                <select class="recording-media">
                    <option value="record-screen">Screen</option>
                </select>
                
                into
                <select class="media-container-format">
                    <option>WebM</option>
                    <option disabled>Mp4</option>
                    <option disabled>WAV</option>
                    <option disabled>Ogg</option>
                    <option>Gif</option>
                </select>
                
                <button>Start Recording</button>
            </h2>
            
            <div style="text-align: center; display: none;">
                <button id="save-to-disk">Save To Disk</button>
                <button id="open-new-tab">Open New Tab</button>
                <button id="upload-to-server">Upload To Server</button>
            </div>
            
            <br>

            <video controls muted></video>
        </section>

  <h2>Recordings</h2>
  <ul id="recordingslist"></ul>

			<p>
				<audio id="audio-preview" controls style="border: 1px solid rgb(15, 158, 238); width: 94%;height: 11em;"></audio> 
			</p><hr />
<div>
				<button id="start-recording">Start Recording</button>
				<button id="stop-recording" disabled="">Stop Recording</button>
			</div>
			
  <h2>Log</h2>
  <pre id="log"></pre>

  <script>
	// AUDIO RECORDING START
		var startRecordingButton = document.getElementById('start-recording');
		var stopRecordingButton = document.getElementById('stop-recording');
		var audioPreview = document.getElementById('audio-preview');
		

var recordAudio;
startRecordingButton.onclick = function () {
	startRecording();
};

var fileName;
stopRecordingButton.onclick = function () {
    stopRecording();
};

function xhr(url, data, callback) {
    var request = new XMLHttpRequest();
    request.onreadystatechange = function () {
        if (request.readyState == 4 && request.status == 200) {
            callback(request.responseText);
        }
    };
    request.open('POST', url);
    request.send(data);
}


	 function __log(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }

  var audio_context;
  var recorder;


  function startRecording() {
		    startRecordingButton.disabled = true;
    navigator.getUserMedia({
        audio: true
    }, function (stream) {
        audioPreview.src = window.URL.createObjectURL(stream);
        audioPreview.play();

        recordAudio = RecordRTC(stream, {
            bufferSize: 16384
        });

        recordAudio.startRecording();

        stopRecordingButton.disabled = false;
    }, function() { });
  }

  function stopRecording() {
	startRecordingButton.disabled = false;
    stopRecordingButton.disabled = true;

    fileName = Math.round(Math.random() * 99999999) + 99999999;

    recordAudio.stopRecording();

    recordAudio.getDataURL(function (audioDataURL) {
        var files = {
            audio: {
                name: fileName + '.wav',
                type: 'audio/wav',
                contents: audioDataURL
            }
        };

        audioPreview.src = '';
        audioPreview.poster = '/ajax-loader.gif';

        xhr(serverURL+'/upload', JSON.stringify(files), function (fileName) {
            /*var href = location.href.substr(0, location.href.lastIndexOf('/') + 1);
            audioPreview.src =  'uploads/' + fileName;
            audioPreview.play();*/

        });
    });
  }
// AUDIO RECORDING END
</script>

        <script>
		var globalFilename = 0; // Will be set before uploading
            (function() {
                var params = {},
                    r = /([^&=]+)=?([^&]*)/g;

                function d(s) {
                    return decodeURIComponent(s.replace(/\+/g, ' '));
                }

                var match, search = window.location.search;
                while (match = r.exec(search.substring(1))) {
                    params[d(match[1])] = d(match[2]);

                    if(d(match[2]) === 'true' || d(match[2]) === 'false') {
                        params[d(match[1])] = d(match[2]) === 'true' ? true : false;
                    }
                }

                window.params = params;
            })();
        </script>
        
        <script>
            var recordingDIV = document.querySelector('.recordrtc');
            var recordingMedia = recordingDIV.querySelector('.recording-media');
            var recordingPlayer = recordingDIV.querySelector('video');
            var mediaContainerFormat = recordingDIV.querySelector('.media-container-format');
            
            recordingDIV.querySelector('button').onclick = function() {
                var button = this;
                
                if(button.innerHTML === 'Stop Recording') {
                    button.disabled = true;
                    button.disableStateWaiting = true;
                    setTimeout(function() {
                        button.disabled = false;
                        button.disableStateWaiting = false;
                    }, 2 * 1000);
                    
                    button.innerHTML = 'Star Recording';

                    function stopStream() {
                        if(button.stream && button.stream.stop) {
                            button.stream.stop();
                            button.stream = null;
                        }
                    }
                    
                    if(button.recordRTC) {
                        if(button.recordRTC.length) {
                            button.recordRTC[0].stopRecording(function(url) {
                                if(!button.recordRTC[1]) {
                                    button.recordingEndedCallback(url);
                                    stopStream();

                                    //saveToDiskOrOpenNewTab(button.recordRTC[0]);
                                    return;
                                }

                                button.recordRTC[1].stopRecording(function(url) {
                                    button.recordingEndedCallback(url);
                                    stopStream();
                                });
                            });
                        }
                        else {
                            button.recordRTC.stopRecording(function(url) {
                                button.recordingEndedCallback(url);
                                stopStream();

                                //saveToDiskOrOpenNewTab(button.recordRTC);
                            });
                        }
                    }
                    
                    return;
                }
                
                button.disabled = true;
                
                var commonConfig = {
                    onMediaCaptured: function(stream) {
                        button.stream = stream;
                        if(button.mediaCapturedCallback) {
                            button.mediaCapturedCallback();
                        }

                        button.innerHTML = 'Stop Recording';
                        button.disabled = false;
                    },
                    onMediaStopped: function() {
                        button.innerHTML = 'Start Recording';
                        
                        if(!button.disableStateWaiting) {
                            button.disabled = false;
                        }
                    },
                    onMediaCapturingFailed: function(error) {
                        if(error.name === 'PermissionDeniedError' && !!navigator.mozGetUserMedia) {
                            InstallTrigger.install({
                                'Foo': {
                                    // https://addons.mozilla.org/firefox/downloads/latest/655146/addon-655146-latest.xpi?src=dp-btn-primary
                                    URL: 'https://addons.mozilla.org/en-US/firefox/addon/enable-screen-capturing/',
                                    toString: function () {
                                        return this.URL; 
                                    }
                                }
                            });
                        }
                        
                        commonConfig.onMediaStopped();
                    }
                };
              
                
                if(recordingMedia.value === 'record-screen') {					
                    captureScreen(commonConfig);
                    
                    button.mediaCapturedCallback = function() {
						startRecording();
                        button.recordRTC = RecordRTC(button.stream, {
                            type: mediaContainerFormat.value === 'Gif' ? 'gif' : 'video',
                            disableLogs: params.disableLogs || false,
                            canvas: {
                                width: Math.floor(screen.width/2),
                                height: Math.floor(screen.height/2)
                            }
                        });
                        
                        button.recordingEndedCallback = function(url) {
                            recordingPlayer.src = null;
                            recordingPlayer.srcObject = null;
							

                            if(mediaContainerFormat.value === 'Gif') {
                                recordingPlayer.pause();
                                recordingPlayer.poster = url;
                                recordingPlayer.onended = function() {
                                    recordingPlayer.pause();
                                    recordingPlayer.poster = URL.createObjectURL(button.recordRTC.blob);
                                };
                                return;
                            }
                            
                            recordingPlayer.src = url;
							// globalFilename will be used to identify the object. No duplicate check.
							globalFilename = Math.floor(Math.random()*99999999);
							__log('Stopping recording and uploading it.');
							stopRecording(); // RecorderJS
							// disabled because we want to upload it first to play it with audio thereafter
                            // recordingPlayer.play();
							// After uploading the mp3, upload the video as well
						    __log('Uploading video.');
							 
							if(!button.recordRTC) return alert('No recording found.');
							uploadToServer(button.recordRTC, function(progress, fileURL) {
								if(progress === 'ended') {									
									// only when uploadedAudio = true it's time for a redirection
										if (uploadedAudio)
										{
											window.location.href=("play.php?id="+globalFilename);
										} else {
											uploadedVideo=true;
										}
									return;
								}
								__log(progress);
							});

                        };
                        
                        button.recordRTC.startRecording();
                    };
                }

     
            };
            
           
            function captureScreen(config) {
                getScreenId(function(error, sourceId, screenConstraints) {
                    if (error === 'not-installed') {
                        document.write('<h1><a target="_blank" href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk">Please install this chrome extension then reload the page.</a></h1>');
                    }

                    if (error === 'permission-denied') {
                        alert('Screen capturing permission is denied.');
                    }

                    if (error === 'installed-disabled') {
                        alert('Please enable chrome screen capturing extension.');
                    }
                    
                    if(error) {
                        config.onMediaCapturingFailed(error);
                        return;
                    }

                    captureUserMedia(screenConstraints, function(screenStream) {
                        recordingPlayer.srcObject = screenStream;
                        recordingPlayer.play();
                        
                        config.onMediaCaptured(screenStream);
                        
                        screenStream.onended = function() {
                            config.onMediaStopped();
                        };
                    }, function(error) {
                        config.onMediaCapturingFailed(error);
                    });
                });
            }

            
            function captureUserMedia(mediaConstraints, successCallback, errorCallback) {
                navigator.mediaDevices.getUserMedia(mediaConstraints).then(successCallback).catch(errorCallback);
            }
            
            function setMediaContainerFormat(arrayOfOptionsSupported) {
                var options = Array.prototype.slice.call(
                    mediaContainerFormat.querySelectorAll('option')
                );
                
                var selectedItem;
                options.forEach(function(option) {
                    option.disabled = true;
                    
                    if(arrayOfOptionsSupported.indexOf(option.value) !== -1) {
                        option.disabled = false;
                        
                        if(!selectedItem) {
                            option.selected = true;
                            selectedItem = option;
                        }
                    }
                });
            }

            function uploadToServer(recordRTC, callback) {
                var blob = recordRTC instanceof Blob ? recordRTC : recordRTC.blob;
                var fileType = blob.type.split('/')[0] || 'audio';				
				if (globalFilename==0)
				{
                globalFilename = Math.floor(Math.random()*99999999);
				}

                // create FormData
                var formData = new FormData();
                formData.append(fileType + '-filename', globalFilename+".webm");
                formData.append(fileType + '-blob', blob);

                callback('Uploading ' + fileType + ' recording to server.');

                makeXMLHttpRequest('save_video.php', formData, function(progress) {
                    if (progress !== 'upload-ended') {
                        callback(progress);
                        return;
                    }

                    var initialURL = location.href.replace(location.href.split('/').pop(), '') + 'uploads_video/';

                    callback('ended', initialURL + globalFilename);

                });
            }

            function makeXMLHttpRequest(url, data, callback) {
                var request = new XMLHttpRequest();
                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        callback('upload-ended');
                    }
                };

                request.upload.onloadstart = function() {
                    callback('Upload started...');
                };

                request.upload.onprogress = function(event) {
                    callback('Upload Progress ' + Math.round(event.loaded / event.total * 100) + "%");
                };

                request.upload.onload = function() {
                    callback('progress-about-to-end');
                };

                request.upload.onload = function() {
                    callback('progress-ended');
                };

                request.upload.onerror = function(error) {
                    callback('Failed to upload to server');
                    console.error('XMLHttpRequest failed', error);
                };

                request.upload.onabort = function(error) {
                    callback('Upload aborted.');
                    console.error('XMLHttpRequest aborted', error);
                };

                request.open('POST', url);
                request.send(data);
            }
        </script>

        
      
        <!--<section class="experiment">
            <h2 class="header" id="feedback">Feedback</h2>
            <div>
                <textarea id="message" style="border: 1px solid rgb(189, 189, 189); height: 8em; margin: .2em; outline: none; resize: vertical; width: 98%;" placeholder="Have any message? Suggestions or something went wrong?"></textarea>
            </div>
            <button id="send-message" style="font-size: 1em;">Send Message</button>
            <small style="margin-left: 1em;">Enter your email too; if you want "direct" reply!</small>
        </section>-->

		<section class="experiment">
            <h2 class="header">Using Chrome Screen Audio</h2>
			<ol>
			<li>
			The audio is first converted to a .mp3 file, which is much smaller than any audio in any video file.  After recording finished, the .mp3 file and the video will get uploaded to the server automatically.
			</li>
			<li>
			Since the webrtc examples do not provide screen and audio recording at the same time in Chrome, this is a workaround to allow recording audio and screen recordings at the same time.
			</li>
			<li>
			This is a fork of <a href="https://www.webrtc-experiment.com/RecordRTC/">https://www.webrtc-experiment.com/RecordRTC/</a> and a combination with <a href="https://github.com/nusofthq/Recordmp3js">https://github.com/nusofthq/Recordmp3js</a>
			</li>
			<li>
Please note: For this to work properly in Chrome, you will have to download and activate this extension: <a href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk">https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk</a>
			</li><li>
A demo will be available on http://www.portostar.com/chrome_screen_and_audio_mp3_recorder (currently you will have to download and install it locally).
			</li>
			
			</ol>
		</section>


        <section class="experiment">
            <h2 class="header">Using RecordRTC</h2>

            <ol>
                <li>
                    You can record both Audio/Video in single file in Firefox.
                </li>

                <li>
                    You can record both Audio/Screen in single file in Firefox.
                </li>

                <li>
                    You can record audio as WAV and video as WebM in Chrome/Opera.
                </li>

                <li>
                    You can record audio as WAV in Microsoft Edge.
                </li>

                <li>
                    You can record remote audios (RTCPeerConnection.onaddstream) in Firefox using "recorderType:StereoAudioRecorder"
                </li>

                <li>
                    You can record Gif in all browsers.
                </li>
            </ol>

            <p style="margin-top: 0;">
                You can even control buffer-size, sample-rates, video-resolutions, etc.
            </p>
        </section>

        <section class="experiment">
            <h2 class="header">Technical Guide</h2>
            <ol>
                <li>
                    Chrome allows getUserMedia invocation on majority of non-file protocols e.g. HTTP/HTTPS/ or inside chrome extension pages. Though, there is always options to use CL (command-line) flags to support file protocols.
                </li>

                <li>
                    (
                    <strong>In Chrome</strong>) RecordRTC captures video frames via Canvas2D; which is encoded in webp-DataURL; now it is using a library named “weppy” which encodes webp into webm.
                </li>

                <li>
                    (
                    <strong>In Firefox</strong>) Under construction - use the complete RecordRTC - RecordRTC is using MediaRecorder API; which supports both audio/video recordings, both in single and multiple files.
                </li>

                <li>
                    (
                    <strong>In Chrome</strong>) RecordRTC is using WebAudio API for audio-recording. Such API has many issues e.g. unable to capture mono audio in wav format; <a href="https://www.webrtc-experiment.com/demos/remote-stream-recording.html">unable to capture remote audio</a>; failure on XP SP2; etc.
                </li>

                <li>
                    (
                    <strong>In Chrome</strong>) If you’re using notebook’s built-in audio input device for audio recording; then you may get "blank" blob.
                </li>

                <li>
                    (
                    <strong>In Chrome</strong>) RecordRTC is incapable to record audio/video in a single file; however there is ffmpeg merging solution available on Github repository.
                </li>
            </ol>
        </section>

        
        <section class="experiment">
			<p style="margin-top: 0;">
                Chrome Screen and Audio is licensed on Github! <a href="https://github.com/portostar/Chrome-Screen-and-Audio" target="_blank">Documentation</a>
            </p>
			<p style="margin-top: 0;">
			Recordmp3js is licensed on Github! <a href="https://github.com/nusofthq/Recordmp3js" target="_blank">Documentation</a>
			</p>
            <p style="margin-top: 0;">
                RecordRTC is MIT licensed on Github! <a href="https://github.com/muaz-khan/RecordRTC" target="_blank">Documentation</a>
            </p>
        </section>

        
    </article>

    <footer>
        <p>
		    <a href="https://github.com/portostar/Chrome-Screen-and-Audio">Chrome Screen and Audio</a> © <a href="https://www.github.com/asciibox" rel="author" target="_blank">Oliver Bachmann</a>
        </p>
    </footer>

</body>

</html>

